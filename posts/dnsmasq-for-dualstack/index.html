<!doctype html><html lang=en-us><head><title>How to configure dnsmasq for dual stack ipv4/ipv6 // Daniel Ops</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Daniel Chavero Gaspar"><meta name=description content><link rel=stylesheet href=https://danielchg.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><meta name=twitter:card content="summary"><meta name=twitter:title content="How to configure dnsmasq for dual stack ipv4/ipv6"><meta name=twitter:description content="Table of Contents Table of Contents Scenario Dnsmasq Installation Configuration Common config per interface DHCP options for ipv4 DHCP options for ipv6 IP reservation DNS resolution for dual stack DNS resolution for wildcard subdomains Troubleshooting Summary Scenario Nowadays it is more and more common to start working with networks that support ipv6, in order to adapt our environment to the new version of the ip stack. Also we want to keep our ipv4 configuration for legacy applications."><meta property="og:title" content="How to configure dnsmasq for dual stack ipv4/ipv6"><meta property="og:description" content="Table of Contents Table of Contents Scenario Dnsmasq Installation Configuration Common config per interface DHCP options for ipv4 DHCP options for ipv6 IP reservation DNS resolution for dual stack DNS resolution for wildcard subdomains Troubleshooting Summary Scenario Nowadays it is more and more common to start working with networks that support ipv6, in order to adapt our environment to the new version of the ip stack. Also we want to keep our ipv4 configuration for legacy applications."><meta property="og:type" content="article"><meta property="og:url" content="https://danielchg.github.io/posts/dnsmasq-for-dualstack/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-03T13:19:23+02:00"><meta property="article:modified_time" content="2023-10-03T13:19:23+02:00"></head><body><header class=app-header><a href=https://danielchg.github.io/><img class=app-header-avatar src=/login-pic.jpg alt="Daniel Chavero Gaspar"></a><h1>Daniel Ops</h1><nav class=app-header-menu><a class=app-header-menu-item href=/posts/>Posts</a>
|
<a class=app-header-menu-item href=/tags/>Tags</a>
|
<a class=app-header-menu-item href=/about/>About Me</a></nav><p>A blog about whatever OPS!!</p><div class=app-header-social><a href=https://github.com/danielchg target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/daniel-chavero-gaspar-19107613/ target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>linkedin</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>How to configure dnsmasq for dual stack ipv4/ipv6</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Oct 3, 2023</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://danielchg.github.io/tags/devops/>DevOps</a>
<a class=tag href=https://danielchg.github.io/tags/networking/>Networking</a></div></div></header><div class=post-content><h1 id=table-of-contents>Table of Contents</h1><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#scenario>Scenario</a></li><li><a href=#dnsmasq>Dnsmasq</a></li><li><a href=#installation>Installation</a></li><li><a href=#configuration>Configuration</a><ul><li><a href=#common-config-per-interface>Common config per interface</a></li><li><a href=#dhcp-options-for-ipv4>DHCP options for ipv4</a></li><li><a href=#dhcp-options-for-ipv6>DHCP options for ipv6</a></li><li><a href=#ip-reservation>IP reservation</a></li><li><a href=#dns-resolution-for-dual-stack>DNS resolution for dual stack</a></li><li><a href=#dns-resolution-for-wildcard-subdomains>DNS resolution for wildcard subdomains</a></li></ul></li><li><a href=#troubleshooting>Troubleshooting</a></li><li><a href=#summary>Summary</a></li></ul><h1 id=scenario>Scenario</h1><p>Nowadays it is more and more common to start working with networks that support ipv6, in order to adapt our environment to the new version of the ip stack. Also we want to keep our ipv4 configuration for legacy applications. In this article I&rsquo;m going to explain how to configure a DHCP and a DNS server to have an environment with support of both ip stacks. This configuration is commonly named dual stack.</p><p>At the moment of this writing I had to configure a lab environment with dual stack support, and it was tedious to me to find the correct configuration for that. The goal of this article is to describe some common configurations such as ip reservations, add DNS entries, etc. Also I have written this article as a personal reference.</p><h1 id=dnsmasq>Dnsmasq</h1><p>Dnsmasq is a lightweight implementation of a DHCP, DNS, router advertisement and network boot, designed for small networks or development and testing environments. This is not intended to be used on production environments.</p><p>The official documentation can be found <a href=https://thekelleys.org.uk/dnsmasq/doc.html>here</a></p><h1 id=installation>Installation</h1><p>Dnsmasq is very popular, and it is included in almost all the Linux distributions, and also there are a lot of community container images available. For this article I&rsquo;m going to use the package available on Fedora 38.</p><p>The below command will install <em>dnsmasq</em> package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo dnf install dnsmasq
</span></span></code></pre></div><p>Once <em>dnsmasq</em> is installed, we have to enable and start the systemd service, as described in the below capture.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo systemctl enable dnsmasq.service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> user: 
</span></span><span style=display:flex><span>Created symlink /etc/systemd/system/multi-user.target.wants/dnsmasq.service → /usr/lib/systemd/system/dnsmasq.service.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo systemctl start dnsmasq
</span></span><span style=display:flex><span>$ systemctl status dnsmasq
</span></span><span style=display:flex><span>● dnsmasq.service - DNS caching server.
</span></span><span style=display:flex><span>     Loaded: loaded <span style=color:#f92672>(</span>/usr/lib/systemd/system/dnsmasq.service; enabled; preset: disabled<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Drop-In: /usr/lib/systemd/system/service.d
</span></span><span style=display:flex><span>             └─10-timeout-abort.conf
</span></span><span style=display:flex><span>     Active: active <span style=color:#f92672>(</span>running<span style=color:#f92672>)</span> since Tue 2023-10-03 19:19:25 CEST; 2s ago
</span></span><span style=display:flex><span>    Process: <span style=color:#ae81ff>75938</span> ExecStart<span style=color:#f92672>=</span>/usr/sbin/dnsmasq <span style=color:#f92672>(</span>code<span style=color:#f92672>=</span>exited, status<span style=color:#f92672>=</span>0/SUCCESS<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   Main PID: <span style=color:#ae81ff>75940</span> <span style=color:#f92672>(</span>dnsmasq<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      Tasks: <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>limit: 18847<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     Memory: 1.2M
</span></span><span style=display:flex><span>        CPU: 6ms
</span></span><span style=display:flex><span>     CGroup: /system.slice/dnsmasq.service
</span></span><span style=display:flex><span>             └─75940 /usr/sbin/dnsmasq
</span></span></code></pre></div><h1 id=configuration>Configuration</h1><p>You can find the whole config file used in this article in <a href=https://gist.github.com/danielchg/fe59f31496d7f1d210123c4d80324565>this GitHub gist</a></p><p>The main config file of <em>dnsmasq</em> in Fedora is in the path <code>/etc/dnsmasq.conf</code>. By default this file contain an entry that permit to add dnsmasq config files in the path <code>/etc/dnsmasq.d/</code>, so we are going to create a file in that path with the name <code>dualstack.conf</code> and the content from the gist linked above. Depending of your environment you should update the values such the domain name, interface, ips, etc.</p><p>Now I&rsquo;m going to explain each section of the config file.</p><h3 id=common-config-per-interface>Common config per interface</h3><p>In the first part of the config I would like to highlight the <code>interface</code> and <code>listen-address</code> fields. These fields allow to configure different DHCP ranges per interface, if we have a server as a central router with multiple interfaces that connect to different subnets, with this configuration we can run different configurations per subnet. In this example it is configured only one interface.</p><pre tabindex=0><code>domain=my.domain.local
domain-needed
interface=ens1f0
bogus-priv
listen-address=192.168.1.1
expand-hosts
server=8.8.8.8
</code></pre><h3 id=dhcp-options-for-ipv4>DHCP options for ipv4</h3><p>As mentioned above we can configure different ip ranges per interface. In this section are configured the <code>dhcp-range</code> to lease ips from <code>192.168.100</code> to <code>192.168.1.200</code> on the interface <code>ens1f0</code> of the machine. Also the rest of the network configs for the DHCP clients, such a DNS and NTP servers.</p><pre tabindex=0><code>dhcp-range=ens1f0,192.168.1.100,192.168.1.200,24h
dhcp-option=ens1f0,option:netmask,255.255.255.0
dhcp-option=ens1f0,option:router,192.168.1.1
dhcp-option=ens1f0,option:dns-server,192.168.1.1
dhcp-option=ens1f0,option:domain-search,my.domain.local
dhcp-option=ens1f0,option:ntp-server,192.168.1.1
dhcp-option=ens1f0,option:classless-static-route,172.16.110.0/24,192.168.1.2
</code></pre><h3 id=dhcp-options-for-ipv6>DHCP options for ipv6</h3><p>The same as for ipv4, we can configure <code>dhcp-range</code> with the ipv6 addresses to the subnet connected to the interface <code>ens1f0</code>. In this example it is used an ipv6 range of <a href=https://en.wikipedia.org/wiki/Unique_local_address>ULA (Unique Local Address)</a>, which is a not Internet routable, similar to the ipv4 private ips. Also I want to highlight a configuration that is specific for ipv6, the <code>enable-ra</code> parameter. This parameter enable the Router Advertisement service on <em>dnsmasq</em>.</p><pre tabindex=0><code>dhcp-range=ens1f0,fd02::100,fd02::200,64,24h
dhcp-option=option6:dns-server,[fd02::1]
enable-ra
dhcp-authoritative
strict-order
</code></pre><h3 id=ip-reservation>IP reservation</h3><p>When you manage a network, sometimes you need to ensure that a host get a specific ip address from the DHCP, in order to allow traffic to that ip on a firewall, or just to ensure that this machine replies to some DNS subdomains on http request. Also it is important to reserve the ip on both stacks. In this part of the config you can see how to add both ips associated with the mac address, and also create a DNS entry for that host. The notations are <code>dhcp-host=&lt;mac address>,&lt;ipv4>,&lt;ipv6>,&lt;DNS hostname></code>.</p><pre tabindex=0><code>dhcp-host=aa:bb:cc:dd:dd:ee,192.168.1.10,[fd02::10],host10.my.doamin.local
dhcp-host=aa:bb:cc:dd:dd:dd,192.168.1.11,[fd02::11],host11.my.doamin.local
</code></pre><h3 id=dns-resolution-for-dual-stack>DNS resolution for dual stack</h3><p>To add DNS entries that resolve two ip stacks, it is required to add two entries in the config file with the same DNS name, each with the ip of each stack. The same thing with the reverse resolution. In the ptr entry I would like to highlight the domain <code>ip6.arpa</code> for the ipv6 reverse resolution.</p><pre tabindex=0><code>address=/www1.my.domain.local/192.168.1.10
address=/www1.my.domain.local/fd02::10
ptr-record=10.1.168.192.in-addr.arpa,www1.my.domain.local
ptr-record=10.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.2.0.d.f.ip6.arpa,www1.my.domain.local
</code></pre><h3 id=dns-resolution-for-wildcard-subdomains>DNS resolution for wildcard subdomains</h3><p>Another common use case is the add entries DNS with a wildcard, like <code>*.apps.my.domain.local</code>. With this example the subdomain <code>test1.apps.my.domain.local</code> and <code>test2.apps.my.domain.local</code> will resolve to the same ip on both stacks.</p><pre tabindex=0><code>address=/.apps.my.domain.local/192.168.1.10
address=/.apps.my.domain.local/fd02::10
</code></pre><h1 id=troubleshooting>Troubleshooting</h1><p>As mentioned above, in Fedora the <em>dnsmasq</em> run as a systemd service, hence to see the logs we need to use <code>journalctl</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>journalctl -u dnsmasq -f
</span></span></code></pre></div><p>If we detect a problem with the lease, such as a reserved ip address that is not assigned to the host with a reservation using the mac address, we can review the lease database in the file <code>/var/lib/dnsmasq/dnsmasq.leases</code>. This is a plain text file, we can edit it with <code>vi</code>, for instance.</p><h1 id=summary>Summary</h1><p>Dnsmasq is a lightweight and easy to use server to run DNS and DHCP services for small networks, or dev and test environments. This support dual stack to configure both ip stacks in the same network.</p></div><div class=post-footer></div></article></main></body></html>