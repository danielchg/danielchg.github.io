<!doctype html><html lang=en-us><head><title>Create an OCP and OLM mirror with oc-mirror plugin // Daniel Ops</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.102.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Daniel Chavero Gaspar"><meta name=description content><link rel=stylesheet href=https://danielchg.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Create an OCP and OLM mirror with oc-mirror plugin"><meta name=twitter:description content="Table of Content Table of Content Context oc-mirror plugin Install Configure Create a mirror Configure credentials to pull OCP images Deploy disconnected registry Create mirror to file Create mirror from file to registry ImageContentSourcePolicies objects Conclusions Links Context At the moment of this writing, I&rsquo;m working in the Telco 5G area at Red Hat, where we work mostly deploying OCP (OpenShift Container Platform) on bare metal. These deployments are focused on clusters that will be placed in remote locations with no Internet access due to security constraints and/or network designs."><meta property="og:title" content="Create an OCP and OLM mirror with oc-mirror plugin"><meta property="og:description" content="Table of Content Table of Content Context oc-mirror plugin Install Configure Create a mirror Configure credentials to pull OCP images Deploy disconnected registry Create mirror to file Create mirror from file to registry ImageContentSourcePolicies objects Conclusions Links Context At the moment of this writing, I&rsquo;m working in the Telco 5G area at Red Hat, where we work mostly deploying OCP (OpenShift Container Platform) on bare metal. These deployments are focused on clusters that will be placed in remote locations with no Internet access due to security constraints and/or network designs."><meta property="og:type" content="article"><meta property="og:url" content="https://danielchg.github.io/posts/oc-mirror/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-29T17:44:18+02:00"><meta property="article:modified_time" content="2022-08-29T17:44:18+02:00"></head><body><header class=app-header><a href=https://danielchg.github.io/><img class=app-header-avatar src=/login-pic.jpg alt="Daniel Chavero Gaspar"></a><h1>Daniel Ops</h1><nav class=app-header-menu><a class=app-header-menu-item href=/posts/>Posts</a>
|
<a class=app-header-menu-item href=/tags/>Tags</a>
|
<a class=app-header-menu-item href=/about/>About Me</a></nav><p>A blog about whatever OPS!!</p><div class=app-header-social><a href=https://twitter.com/dani_chg target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/danielchg target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/daniel-chavero-gaspar-19107613/ target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>linkedin</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Create an OCP and OLM mirror with oc-mirror plugin</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Aug 29, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>11 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://danielchg.github.io/tags/devops/>devops</a>
<a class=tag href=https://danielchg.github.io/tags/openshift/>openshift</a></div></div></header><div class=post-content><h1 id=table-of-content>Table of Content</h1><ul><li><a href=#table-of-content>Table of Content</a><ul><li><a href=#context>Context</a></li><li><a href=#oc-mirror-plugin>oc-mirror plugin</a><ul><li><a href=#install>Install</a></li><li><a href=#configure>Configure</a></li></ul></li><li><a href=#create-a-mirror>Create a mirror</a><ul><li><a href=#configure-credentials-to-pull-ocp-images>Configure credentials to pull OCP images</a></li><li><a href=#deploy-disconnected-registry>Deploy disconnected registry</a></li><li><a href=#create-mirror-to-file>Create mirror to file</a></li><li><a href=#create-mirror-from-file-to-registry>Create mirror from file to registry</a></li><li><a href=#imagecontentsourcepolicies-objects>ImageContentSourcePolicies objects</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#links>Links</a></li></ul></li></ul><h2 id=context>Context</h2><p>At the moment of this writing, I&rsquo;m working in the Telco 5G area at Red Hat, where we work mostly deploying OCP (OpenShift Container Platform) on bare metal. These deployments are focused on clusters that will be placed in remote locations with no Internet access due to security constraints and/or network designs.</p><p>To install an OCP cluster needs Internet access to pull container images from registries managed by Red Hat, because all the OCP components are container images. This is a limitation of the scenario described before. And this is the reason why it is required to create a mirror in a disconnected registry with the needed images to install OpenShift, from where to install a bare metal cluster without Internet access.</p><p>All the command line examples are run on a RHEL machine, how to do it with other OS is not the goal of this article.</p><p>The procedure refers to a possible production solution with multiple hosts in different networks with access restrictions, but for learning purposes, it is described how to do it in a single host.</p><h2 id=oc-mirror-plugin>oc-mirror plugin</h2><p>The newest version of OCP at this moment is <strong>4.11</strong>. This version comes with a lot of new interested features, and one of this features is the <code>oc-mirror</code> plugin.</p><p>Until now, to create a mirror of the OCP and OLM (Operator Lifecycle Manager) repositories, you had to use a sub-command of the <code>oc</code> CLI. The workflow to create the mirror and maintain it synced was very tedious (you can read the whole procedure in the <a href=https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-installation-images.html>OCP official documentation</a>). This is the reason why Red Hat has made an effort to simplify this procedure creating this plugin for <code>oc</code>.</p><p>If you are interested in the source code of <code>oc-mirror</code> plugin you can find it in <a href=https://github.com/openshift/oc-mirror>their GitHub repository</a>.</p><h3 id=install>Install</h3><p>The <code>oc-mirror</code> plugin is writen in Golang, hence this is just a binary that you can download to your machine, copy it to some place in your <code>$PATH</code> and add execution permissions. It can be downloaded from the <a href=https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.2/>offical OCP release site</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.2/oc-mirror.tar.gz -o oc-mirror.tgz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tar zxvf oc-mirror.tgz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mv oc-mirror /usr/sbin/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x /usr/sbin/oc-mirror
</span></span></code></pre></div><p>You can check if everything works properly showing the version.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc-mirror version
</span></span><span style=display:flex><span>Client Version: version.Info<span style=color:#f92672>{</span>Major:<span style=color:#e6db74>&#34;&#34;</span>, Minor:<span style=color:#e6db74>&#34;&#34;</span>, GitVersion:<span style=color:#e6db74>&#34;4.11.0-202208031306.p0.g3c1c80c.assembly.stream-3c1c80c&#34;</span>, GitCommit:<span style=color:#e6db74>&#34;3c1c80ca6a5a22b5826c88897e7a9e5acd7c1a96&#34;</span>, GitTreeState:<span style=color:#e6db74>&#34;clean&#34;</span>, BuildDate:<span style=color:#e6db74>&#34;2022-08-03T14:23:35Z&#34;</span>, GoVersion:<span style=color:#e6db74>&#34;go1.18.4&#34;</span>, Compiler:<span style=color:#e6db74>&#34;gc&#34;</span>, Platform:<span style=color:#e6db74>&#34;linux/amd64&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=configure>Configure</h3><p>One of the improvements of <code>oc-mirror</code>, in comparison with the previous procedure using <code>oc adm</code> command, is that you can define the caracteristics of your mirror via a config file, and this file can be versioned using <code>git</code>, or any other version control system. This helps a lot in the lifecycle maintenance of your mirror. <code>oc-mirror</code> understand the contend of a <strong>YAML</strong> file called <code>imageSetConfiguration</code>. You can find generate a base file based on a template with the below commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ podman login registry.redhat.io
</span></span><span style=display:flex><span>Username: &lt;YOUR_USERNAME&gt;
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>Login Succeeded!
</span></span><span style=display:flex><span>$ mkdir ~/oc-mirror-demo
</span></span><span style=display:flex><span>$ oc-mirror init &gt; ~/oc-mirror-demo/imagesetconfig.yaml
</span></span></code></pre></div><p>Let&rsquo;s review the structure of the <code>imagesetconfig.yaml</code> file and the meaning of each field.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ImageSetConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>mirror.openshift.io/v1alpha2</span> <span style=color:#75715e># 1 </span>
</span></span><span style=display:flex><span><span style=color:#f92672>storageConfig</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>local</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>./</span> <span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>mirror</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>platform</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>channels</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>stable-4.11</span> <span style=color:#75715e># 3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ocp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>operators</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>catalog</span>: <span style=color:#ae81ff>registry.redhat.io/redhat/redhat-operator-index:v4.11</span> <span style=color:#75715e># 4</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>packages</span>: <span style=color:#75715e># 5</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>serverless-operator</span> <span style=color:#75715e># 6</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>channels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>stable</span> <span style=color:#75715e># 7</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>additionalImages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>registry.redhat.io/ubi8/ubi:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>helm</span>: {}
</span></span></code></pre></div><ol><li>Each version of <code>oc-mirror</code> required an specific <code>apiVersion</code>.</li><li>This is the path where the metadata of each mirror run is saved.</li><li>The channel to retrieve the OpenShift Container Platform images from.</li><li>The <strong>OLM</strong> catalog source that we are going to use.</li><li>Based on the previous catalog, winthin this field is spected an array with all the operators to be mirrored.</li><li>This is the name of operator.</li><li>The channel of the operator.</li></ol><p>In the example above it is configured to create a mirror of the whole <strong>OCP 4.11</strong> and only the <strong>serverless-operator</strong> from <strong>OLM</strong></p><h2 id=create-a-mirror>Create a mirror</h2><p>When you are going to create a mirror to deploy a disconnected environment there are different ways to do it. The best way for you depend of the your usecase.</p><ul><li><p><strong>Partially Disconnected:</strong> You can create a mirror directly from the public Quay.io to your disconnected registry, what is faster because you only need one step to create the mirror.</p></li><li><p><strong>Fully Disconnected:</strong> If you have a very restrict network, and the servers where the cluster is going to be deployed don&rsquo;t have Internet access, you can create in a first step a mirror to a file, and later on copy this file to the place where the disconnected registry is. This last case is what I&rsquo;m going to descrebe in this article. I think that is the most complex use case and maybe more use full to have a better understanding about how this procedure works.</p></li></ul><p>Below in the diagram are shown the steps needed to create a Fully Disconnected mirror.</p><p><img src=/disconnected-registry.png alt="Disconnected registry"></p><ol><li>Create a mirror from Quay.io to a local file in your workstation.</li><li>Copy the mirror file from your workstation to a server with access to the disconnected registry with Internet connection restrictions</li><li>Import the mirror from file to the disconnected registry.</li></ol><h3 id=configure-credentials-to-pull-ocp-images>Configure credentials to pull OCP images</h3><p>In order to allow <code>oc-mirror</code> to pull the OCP images from the Red Hat registries, you need to configure your credentials.</p><p>First of all you need to create a <strong>Red Hat</strong> account in <a href=https://www.redhat.com/en/technologies/cloud-computing/openshift/try-it>this link</a>, select <strong>Self-managed</strong> option and follow the required steps to create an account.</p><p>Once you have an account you can download your pull secrets from <a href=https://console.redhat.com/openshift/downloads#tool-pull-secret>here</a>. Now you have to add this information to your <code>podman</code> auth configuration with the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat pull-secrets.txt | jq &gt; $XDG_RUNTIME_DIR/containers/auth.json
</span></span></code></pre></div><h3 id=deploy-disconnected-registry>Deploy disconnected registry</h3><p>In order to follow this tutorial it is required a running registry where we are going to push all the mirror images. Just for testing purpose I have deployed it with <a href=https://github.com/danielchg/oc-mirror-procedure/blob/main/deploy_registry.sh>this script</a>. There are multiples ways to deploy a registry, for instance Red Had has a light version of Quay.io for this purpose, that is documented <a href=https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-creating-registry.html>in here</a>.</p><p>You can follow the below commands if you are running this on RHEL or Fedora.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/danielchg/oc-mirror-procedure.git
</span></span><span style=display:flex><span>cd oc-mirror-procedure/
</span></span><span style=display:flex><span>./deploy_registry.sh
</span></span></code></pre></div><p>This script will deploy a registry that will listen on port <code>5000/TCP</code>, with TLS support and authentication with credentials <code>dummy/dummy</code>. In order to check the installation follow the below commands, be aware that an entry is added to the <code>/etc/hosts</code> due to the use of TLS. For this tutorial we are going to use the same machine for what is called Workstatin, Installer Machine and Disconnected Registry in the diagram above, but in a real scenario these should be different hosts.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Check if the container with the registry is running</span>
</span></span><span style=display:flex><span>$ podman ps
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                         COMMAND               CREATED        STATUS            PORTS       NAMES
</span></span><span style=display:flex><span>37670395eb29  docker.io/library/registry:2  /etc/docker/regis...  <span style=color:#ae81ff>3</span> seconds ago  Up <span style=color:#ae81ff>4</span> seconds ago              registry
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add entry to the /etc/hosts</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;127.0.0.1 registry.local&#34;</span> | sudo tee -a /etc/hosts
</span></span><span style=display:flex><span>127.0.0.1 registry.local
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Login to the registry</span>
</span></span><span style=display:flex><span>$ podman login registry.local:5000
</span></span><span style=display:flex><span>Username: dummy
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>Login Succeeded!
</span></span></code></pre></div><h3 id=create-mirror-to-file>Create mirror to file</h3><p>At this moment we should have in our Fedora machine the <code>oc-mirror</code> installed, and a disconnected registry running. The next step is to create a mirror from Quay.io to a file. We are going to use the file generated by the <code>oc-mirror init</code> command that we have run before. Be aware that we required an account with permission to pull the OCP container images from registry.redhat.io, if you don&rsquo;t have already an account, please visit the <a href="https://sso.redhat.com/auth/realms/redhat-external/login-actions/registration?client_id=rh_product_trials&tab_id=1Ks3qWXNdKY">Red Hat site</a> in order to create it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ podman login registry.redhat.io
</span></span><span style=display:flex><span>Username: dchavero
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>Login Succeeded!
</span></span></code></pre></div><p>Once you have loged in registry.redhat.io we can run the <code>oc-mirror</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd ~/oc-mirror-demo
</span></span><span style=display:flex><span>/usr/sbin/oc-mirror --config imagesetconfig.yaml file:///root/oc-mirror-demo/archives
</span></span><span style=display:flex><span>Creating directory: /root/oc-mirror-demo/archives/oc-mirror-workspace/src/publish
</span></span><span style=display:flex><span>Creating directory: /root/oc-mirror-demo/archives/oc-mirror-workspace/src/v2
</span></span><span style=display:flex><span>Creating directory: /root/oc-mirror-demo/archives/oc-mirror-workspace/src/charts
</span></span><span style=display:flex><span>Creating directory: /root/oc-mirror-demo/archives/oc-mirror-workspace/src/release-signatures
</span></span><span style=display:flex><span>No metadata detected, creating new workspace
</span></span><span style=display:flex><span>wrote mirroring manifests to /root/oc-mirror-demo/archives/oc-mirror-workspace/operators.1662238754/manifests-redhat-operator-index
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To upload local images to a registry, run:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	oc adm catalog mirror file://redhat/redhat-operator-index:v4.11 REGISTRY/REPOSITORY
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info: Mirroring completed in 2m25.38s <span style=color:#f92672>(</span>130.8MB/s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Creating archive /root/oc-mirror-demo/archives/mirror_seq1_000000.tar
</span></span></code></pre></div><p>The output should be something similar to the above, only the first and last lines are shown, the rest has been ommited due to de ammount of lines.</p><p>As you can see in the last line of the log the path to the file with the mirror is <code>/root/oc-mirror-demo/archives/mirror_seq1_000000.tar</code>, hence this is the file that we need to copy to the restricted location whith access to the disconnected registry. The that you copy this file to that place depend of your use case and your security requirements, the only important thing is to copy it to that place.</p><p>The directory structure after the execution should be something like below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tree .
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── archives
</span></span><span style=display:flex><span>│   ├── mirror_seq1_000000.tar
</span></span><span style=display:flex><span>│   └── oc-mirror-workspace
</span></span><span style=display:flex><span>├── imagesetconfig.yaml
</span></span><span style=display:flex><span>└── publish
</span></span></code></pre></div><p>Also there are a log file <code>.oc-mirror.log</code> where is saved all the output.</p><h3 id=create-mirror-from-file-to-registry>Create mirror from file to registry</h3><p>In my lab I&rsquo;m going to run this part of the procedure in the same machine, but in a real production environment you should copy the generated file <code>mirror_seq1_000000.tar</code> to the Installer Machine, from where the below command should be run to import the images in the Disconnected Registry. I know that I already told about this, but it is important that these aspects of the lab vs production are clear for a better understanding.</p><p>In order to import the images from the mirror file to our Disconnected Registry we just need to run the below command from the same folder as the before step, but actually you only need access to the <code>mirror_seq1_000000.tar</code> for this step, the rest of the content of the folder are important for future runs to create the mirror to file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ /usr/sbin/oc-mirror --from ./archives/mirror_seq1_000000.tar docker://registry.local:5000/oc-mirror --dest-skip-tls
</span></span><span style=display:flex><span>Checking push permissions <span style=color:#66d9ef>for</span> registry.local:5000
</span></span><span style=display:flex><span>Publishing image set from archive <span style=color:#e6db74>&#34;./archives/mirror_seq1_000000.tar&#34;</span> to registry <span style=color:#e6db74>&#34;registry.local:5000&#34;</span>
</span></span><span style=display:flex><span>registry.local:5000/
</span></span><span style=display:flex><span>  oc-mirror/openshift/release
</span></span><span style=display:flex><span>    blobs:
</span></span><span style=display:flex><span>      file://openshift/release sha256:545277d800059b32cf03377a9301094e9ac8aa4bb42d809766d7355ca9aa8652 1.753KiB
</span></span><span style=display:flex><span>      file://openshift/release sha256:c052f5b9bb68f5cf7676f99f56a53f673d0c25ce2109d596148a5eea4c8e68e4 5.885KiB
</span></span><span style=display:flex><span>      file://openshift/release sha256:8471560c450b0951780fd61a8df6c1b98154fde18036f7c091de2316da33bf6a 11.47MiB
</span></span><span style=display:flex><span>      file://openshift/release sha256:e46a55fccddefc1d37574b70cd4e5c54fc3d795c51543b729d6c93051e1be9e3 35.43MiB
</span></span><span style=display:flex><span>      file://openshift/release sha256:630499beaeb04bcb68b94f4a413a3626b152e3c211d5fbab3a2813047baaf079 57.83MiB
</span></span><span style=display:flex><span>      file://openshift/release sha256:f70d60810c69edad990aaf0977a87c6d2bcc9cd52904fa6825f08507a9b6e7bc 74.8MiB
</span></span><span style=display:flex><span>    manifests:
</span></span><span style=display:flex><span>      sha256:b4023de0e31fc7d448254794512f6b1e0c01226953063d253238aa051761a683 -&gt; 4.11.1-x86_64-cloud-credential-operator
</span></span><span style=display:flex><span>  stats: shared<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> unique<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> size<span style=color:#f92672>=</span>179.5MiB ratio<span style=color:#f92672>=</span>1.00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>phase 0:
</span></span><span style=display:flex><span>  registry.local:5000 oc-mirror/openshift/release blobs<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> mounts<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> manifests<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> shared<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info: Planning completed in 20ms
</span></span><span style=display:flex><span>uploading: registry.local:5000/oc-mirror/openshift/release sha256:630499beaeb04bcb68b94f4a413a3626b152e3c211d5fbab3a2813047baaf079 57.83MiB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>phase 0:
</span></span><span style=display:flex><span>  registry.local:5000 oc-mirror/openshift/release blobs<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> mounts<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> manifests<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> shared<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info: Planning completed in 10ms
</span></span><span style=display:flex><span>uploading: registry.local:5000/oc-mirror/openshift/release sha256:646ce49c160e0610d41b7b0b59936938df136232dd7efe91796a0d9497682994 26.53MiB
</span></span><span style=display:flex><span>sha256:4e0b8de27a9295163d397b1c7b9fd77a18276df6fb36076fb4423ce89877aa59 registry.local:5000/oc-mirror/openshift/release:4.11.1-x86_64-cluster-autoscaler
</span></span><span style=display:flex><span>info: Mirroring completed in 360ms <span style=color:#f92672>(</span>76.25MB/s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Wrote release signatures to oc-mirror-workspace/results-1662308847
</span></span><span style=display:flex><span>Rendering catalog image <span style=color:#e6db74>&#34;registry.local:5000/oc-mirror/redhat/redhat-operator-index:v4.11&#34;</span> with file-based catalog 
</span></span><span style=display:flex><span>Writing image mapping to oc-mirror-workspace/results-1662308847/mapping.txt
</span></span><span style=display:flex><span>Writing CatalogSource manifests to oc-mirror-workspace/results-1662308847
</span></span><span style=display:flex><span>Writing ICSP manifests to oc-mirror-workspace/results-1662308847
</span></span></code></pre></div><p>As the previous run I have caputured only part of the output of the command, the first part just to show what is expected to see at the beggining, and the end of the log, because in here there are important information that we have to use for the next steps.</p><p>At this point should see something like below in our folder.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tree .
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── archives
</span></span><span style=display:flex><span>│   ├── mirror_seq1_000000.tar
</span></span><span style=display:flex><span>│   └── oc-mirror-workspace
</span></span><span style=display:flex><span>├── imagesetconfig.yaml
</span></span><span style=display:flex><span>├── oc-mirror-workspace
</span></span><span style=display:flex><span>│   ├── publish
</span></span><span style=display:flex><span>│   └── results-1662308847
</span></span><span style=display:flex><span>│       ├── catalogSource-redhat-operator-index.yaml
</span></span><span style=display:flex><span>│       ├── charts
</span></span><span style=display:flex><span>│       ├── imageContentSourcePolicy.yaml
</span></span><span style=display:flex><span>│       ├── mapping.txt
</span></span><span style=display:flex><span>│       └── release-signatures
</span></span><span style=display:flex><span>│           └── signature-sha256-97410a5db655a9d3.json
</span></span><span style=display:flex><span>└── publish
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span> directories, <span style=color:#ae81ff>6</span> files
</span></span></code></pre></div><p>As you can see there are new files within <code>oc-mirror-workspace/results-1662308847</code>. These files are described in the next section.</p><h3 id=imagecontentsourcepolicies-objects>ImageContentSourcePolicies objects</h3><p>That&rsquo;s awesome! We already have our <strong>Disconnected Registry</strong> with all the images to required to deploy our cluster in a restricted network. But how I install my cluster using these images instead of the public images that the <code>openshift-installer</code> normally use? That&rsquo;s a great question, and this is the reason why exist the objects <strong>ImageContentSourcePolicies</strong>. These object create a mapping between the public registries and our disconnected registry, in order to modify the CRI-O configuration to pull all the needed images from our Disconnected Registry instead of the Internet registry. Let&rsquo;s take a look to the content of one of this files for better understanding.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat oc-mirror-workspace/results-1662308847/imageContentSourcePolicy.yaml 
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: operator.openshift.io/v1alpha1
</span></span><span style=display:flex><span>kind: ImageContentSourcePolicy
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: generic-0
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  repositoryDigestMirrors:
</span></span><span style=display:flex><span>  - mirrors:
</span></span><span style=display:flex><span>    - registry.local:5000/oc-mirror/ubi8
</span></span><span style=display:flex><span>    source: registry.redhat.io/ubi8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>In this part of the file we can see that a <code>ImageConteSourcePolicy</code> object with name <code>generic-0</code> will update the CRI-O configuration to pull all the images from the registry <code>registry.redhat.io/ubi8</code> from the Disconnected Registry <code>registry.local"5000/oc-mirror/ubi8</code>. We can just try to pull this image from our Disconnected Registry in order to validate that actually this image is in there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ podman pull registry.local:5000/oc-mirror/ubi8/ubi:latest
</span></span><span style=display:flex><span>Trying to pull registry.local:5000/oc-mirror/ubi8/ubi:latest...
</span></span><span style=display:flex><span>Getting image source signatures
</span></span><span style=display:flex><span>Copying blob 0d51f270409c <span style=color:#66d9ef>done</span>  
</span></span><span style=display:flex><span>Copying blob 480a8b2c25e9 <span style=color:#66d9ef>done</span>  
</span></span><span style=display:flex><span>Copying config 343496049f <span style=color:#66d9ef>done</span>  
</span></span><span style=display:flex><span>Writing manifest to image destination
</span></span><span style=display:flex><span>Storing signatures
</span></span><span style=display:flex><span>343496049fae3aadfc5c63064bbae33bce2e1511fa7b1a9522dca3cd9c318f6b
</span></span></code></pre></div><p>It is important to be aware that the content of the <code>ImageContentSourcePolicy</code> make reference only to the registry repository no to the container image. As you can see in the command above the image that we try to pull is <code>registry.local:5000/oc-mirror/ubi8/ubi:latest</code> not just <code>registry.local:5000/oc-mirror/ubi8</code>.</p><p>How to use these ICSPs objects depend of the status of your cluster, if you are going to start an OCP installation from scratch, there are a section in the <code>install-config.yaml</code> to add these configs, and if you have a cluster already running and you just need to update the ICSPs objects just apply this YAML files with <code>oc apply -f</code>.</p><h2 id=conclusions>Conclusions</h2><p>Currently there are a lot of use cases where a disconnected installation of an OCP cluster is required, and it is important that the procedure to create and maintain a disconnected registry should be as easier as posible. With this new <code>oc-mirror</code> plugin the whole procedure has been simplify and also there are multimple improvements like the inrcremental download on each run vs the full download with the previous approach. Moreover, nowadays with DevOps culture and GitOps methodology, it is good to have a way to keep tracking in a Git reposotory of all the changes and track with a CI/CD tool the runs to create and/or maintain the Disconnected Registry. I think it is a worthy tool that helps a lot for production environments.</p><h2 id=links>Links</h2><ul><li><a href=https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-installation-images.html>Disconnected mirror</a></li><li><a href=https://github.com/openshift/oc-mirror>oc-mirror GitHub repository</a></li><li><a href=https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-creating-registry.html>Mirror Registry</a></li><li><a href=https://console.redhat.com/openshift/downloads#tool-pull-secret>Get pull secrets</a></li></ul></div><div class=post-footer></div></article></main></body></html>